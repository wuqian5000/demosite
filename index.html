<!DOCTYPE html>
<html>

<head>
    <title>Mental Health Dashboard</title>
    <!-- Script includes -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <style>
        /* Base styles */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            max-width: 1400px;
            margin: 0 auto;
            overflow-x: hidden;
        }

        .student-row {
            transition: background-color 0.3s ease;
        }

        .student-row.highlighted {
            background-color: #f3e8ff;
        }

        .student-row:hover {
            background-color: #f8f8f8;
        }

        .student-row.highlighted:hover {
            background-color: #e9d5ff;
        }

        .header {
            background-color: white;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .dashboard-title {
            color: #9333ea;
            margin: 0;
            font-size: 1.5em;
        }

        .nav {
            display: flex;
            gap: 20px;
            margin-top: 10px;
        }

        .nav-item {
            color: #9333ea;
            text-decoration: none;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .nav-item:hover {
            background-color: #f3e8ff;
        }

        /* View Toggle Container */
        #viewToggleContainer {
            position: absolute;
            right: 16px;
            top: 16px;
            z-index: 10;
            display: flex;
            gap: 8px;
        }

        /* Toggle Button Styles */
        .toggle-button {
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            background-color: #f3f4f6;
            color: #4b5563;
            border: none;
            cursor: pointer;
        }

        .toggle-button:hover {
            background-color: #e5e7eb;
        }

        .toggle-button.active {
            background-color: #9333ea;
            color: white;
        }

        /* Filters */
        .filters {
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-label {
            font-size: 0.8em;
            color: #666;
        }

        select,
        input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9em;
            width: 100%;
        }

        /* Chart layouts */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            width: 100%;
            max-width: 100%;
            overflow-x: hidden;
        }

        .main-chart-area,
        .detail-chart-area,
        .line-chart-area,
        .bar-chart-area {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: none;
        }

        .main-chart-area {
            display: block;
        }

        .chart-wrapper {
            height: 400px;
            width: 100%;
            max-width: 100%;
            position: relative;
            overflow-x: hidden;
            padding: 20px;
        }

        .chart-title {
            color: #666;
            margin-bottom: 15px;
            font-size: 1.1em;
            text-align: center;
        }

        .line-chart-mode {
            grid-template-columns: 1fr !important;
            max-width: 100%;
            overflow-x: hidden;
        }

        /* Chart controls layout */
        .chart-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 15px;
            align-items: center;
            max-width: 100%;
            overflow-x: hidden;
        }

        .chartLegend {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            max-width: 100%;
        }

        .toggle-button-chart {
            padding: 6px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            font-size: 0.9em;
        }

        .toggle-button-chart.active {
            background: #9333ea;
            color: white;
            border-color: #9333ea;
        }

        .data-point-info {
            position: fixed;
            background: white;
            padding: 12px;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            font-size: 0.9em;
            display: none;
            z-index: 1000;
        }

        /* Legend styles */
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9em;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .legend-item:hover {
            background: #f0f0f0;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }

        .legend-item.hidden .legend-color {
            border-bottom: 2px dashed #333;
            background: transparent;
        }

        /* Data table */
        .data-table {
            width: 100%;
            max-width: 100%;
            table-layout: fixed;
        }

        .data-table th,
        .data-table td {
            padding: 8px;
            text-align: center;
            border: 1px solid #eee;
            font-size: 0.9em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .data-table th {
            background: #f8f8f8;
        }

        .data-table-container {
            width: 100%;
            max-width: 100%;
            overflow-x: auto;
            margin-top: 20px;
        }

        /* Side panel and student list */
        .side-panel {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
            max-height: 800px;
        }

        .student-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .student-table th,
        .student-table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #eee;
            font-size: 0.9em;
        }

        .student-table th {
            color: #666;
            font-weight: 600;
            background: #f8f8f8;
        }

        .emotion-tag {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            color: white;
        }

        .emotion-tag.positive {
            background: #9333ea;
        }

        .emotion-tag.neutral {
            background: #90EE90;
        }

        .emotion-tag.concerned {
            background: #4169E1;
        }

        .emotion-tag.negative {
            background: #CD5C5C;
        }

        .filter-info {
            padding: 10px;
            background: #f8f8f8;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 0.9em;
            color: #666;
        }

        .panel-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        /* Back button */
        .back-button {
            display: none;
            background: #9333ea;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 10px;
            font-size: 0.9em;
        }

        .back-button:hover {
            background: #7e22ce;
        }

        /* Ensure canvas elements do not exceed container width */
        canvas {
            max-width: 100%;
            display: block;
        }

        /* Additional styles for the bar chart view */
        .chart-toggle-group {
            display: flex;
            gap: 0;
            margin-bottom: 15px;
        }

        .chart-toggle-button {
            padding: 8px 16px;
            border: 1px solid #9333ea;
            background: white;
            color: #9333ea;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9em;
        }

        .chart-toggle-button:first-child {
            border-radius: 4px 0 0 4px;
        }

        .chart-toggle-button:last-child {
            border-radius: 0 4px 4px 0;
        }

        .chart-toggle-button.active {
            background: #9333ea;
            color: white;
        }

        .bar-chart-area {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: none;
        }

        .bar-chart-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
            justify-content: center;
        }

        .bar-chart-legend .legend-item {
            cursor: pointer;
        }

        .legend-item.hidden {
            opacity: 0.5;
        }
    </style>
</head>

<body>
    <div class="header">
        <h1 class="dashboard-title"></h1>
        <!-- View Toggle Container -->
        <div id="viewToggleContainer"></div>
        <nav class="nav">
            <a href="#" class="nav-item"></a>
            <a href="#" class="nav-item"></a>
            <a href="#" class="nav-item"></a>
        </nav>
    </div>

    <div class="filters">
        <div class="filter-group">
            <label class="filter-label">Start Date</label>
            <input type="date" value="2024-10-01" id="startDate">
        </div>
        <div class="filter-group">
            <label class="filter-label">End Date</label>
            <input type="date" value="2024-10-31" id="endDate">
        </div>
        <div class="filter-group">
            <label class="filter-label">Chart Type</label>
            <select id="chartType">
                <option value="pie" selected>Pie</option>
                <option value="line">Line</option>
                <option value="bar">Bar</option>
            </select>
        </div>
        <div class="filter-group">
            <label class="filter-label">Organization</label>
            <select id="organization">
                <option value="test">Test Org</option>
            </select>
        </div>
        <div class="filter-group">
            <label class="filter-label">Class/Group</label>
            <select id="class">
                <option value="all">All Classes</option>
            </select>
        </div>
    </div>

    <div class="dashboard-grid">
        <div class="chart-container">
            <!-- Pie Chart View -->
            <div class="main-chart-area">
                <div class="chart-title">Overall Emotion Distribution</div>
                <div class="chart-wrapper">
                    <canvas id="mainChart"></canvas>
                </div>
            </div>

            <!-- Detail Pie Chart View -->
            <div class="detail-chart-area">
                <button class="back-button">‚Üê Back to Overview</button>
                <div class="chart-title">Detailed View</div>
                <div class="chart-wrapper">
                    <canvas id="detailChart"></canvas>
                </div>
            </div>

            <!-- Line Chart View -->
            <div class="line-chart-area">
                <div class="chart-title">Emotion Trends Over Time</div>
                <div class="chart-controls">
                    <div style="display: flex; gap: 10px;">
                        <button class="toggle-button-chart active" data-view="all">All Emotions</button>
                        <button class="toggle-button-chart" data-view="category">By Category</button>
                    </div>
                    <div id="chartLegend" style="display: flex; gap: 15px; flex-wrap: wrap;"></div>
                </div>
                <div class="chart-wrapper">
                    <canvas id="lineChart"></canvas>
                </div>
                <div class="data-point-info" id="dataPointInfo"></div>
                <div class="data-table-container">
                    <table class="data-table" id="dataTable">
                        <!-- Will be populated by JavaScript -->
                    </table>
                </div>
            </div>

            <!-- Bar Chart Area -->
            <div class="bar-chart-area">
                <div class="chart-toggle-group">
                    <button class="chart-toggle-button active" data-view="standard">Standard</button>
                    <button class="chart-toggle-button" data-view="negative">With Negatives</button>
                </div>
                <div class="chart-wrapper">
                    <canvas id="barChart"></canvas>
                </div>
                <div class="bar-chart-legend" id="barChartLegend">
                    <!-- Legend items will be added here -->
                </div>
            </div>
        </div>

        <div class="side-panel">
            <div class="panel-title">
                <span>Student List</span>
                <span id="studentCount" style="color: #666; font-size: 0.9em;"></span>
            </div>
            <div class="filter-info" id="filterInfo">Showing all students</div>
            <table class="student-table">
                <thead>
                    <tr>
                        <th>Student Name</th>
                        <th>Emotion</th>
                    </tr>
                </thead>
                <tbody id="studentTableBody">
                    <!-- Will be populated by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // View switching functionality
        function initializeViewToggle() {
            const viewToggleContainer = document.getElementById('viewToggleContainer');
            const currentView = window.location.pathname.includes('principal') ? 'principal' : 'counselor';

            // Create toggle buttons
            viewToggleContainer.innerHTML = `
                <button 
                    onclick="switchView('counselor')" 
                    class="toggle-button ${currentView === 'counselor' ? 'active' : ''}">
                    Counselor View
                </button>
                <button 
                    onclick="switchView('principal')" 
                    class="toggle-button ${currentView === 'principal' ? 'active' : ''}">
                    Principal View
                </button>
            `;
        }

        function switchView(view) {
            // Store current filters and state if needed
            const currentFilters = {
                startDate: document.getElementById('startDate').value,
                endDate: document.getElementById('endDate').value,
                chartType: document.getElementById('chartType').value,
                organization: document.getElementById('organization').value,
                classGroup: document.getElementById('class').value
            };
            localStorage.setItem('dashboardFilters', JSON.stringify(currentFilters));

            // Switch to the appropriate view
            if (view === 'principal') {
                window.location.href = 'principal.html';
            } else {
                window.location.href = 'index.html';
            }
        }

        // Initialize the toggle buttons
        document.addEventListener('DOMContentLoaded', initializeViewToggle);

        // Event Handler for Chart Type Selection
        const chartTypeSelect = document.getElementById('chartType');
        chartTypeSelect.addEventListener('change', function (e) {
            const chartType = e.target.value;
            const mainChartArea = document.querySelector('.main-chart-area');
            const detailChartArea = document.querySelector('.detail-chart-area');
            const lineChartArea = document.querySelector('.line-chart-area');
            const barChartArea = document.querySelector('.bar-chart-area');
            const sidePanel = document.querySelector('.side-panel');
            const dashboardGrid = document.querySelector('.dashboard-grid');

            // Hide all chart areas first
            mainChartArea.style.display = 'none';
            detailChartArea.style.display = 'none';
            lineChartArea.style.display = 'none';
            barChartArea.style.display = 'none';

            if (chartType === 'line') {
                lineChartArea.style.display = 'block';
                sidePanel.style.display = 'none';
                dashboardGrid.classList.add('line-chart-mode');
                createLineChart(currentView);
            } else if (chartType === 'bar') {
                barChartArea.style.display = 'block';
                sidePanel.style.display = 'block';
                dashboardGrid.classList.remove('line-chart-mode');
                initializeBarChart();
            } else {
                mainChartArea.style.display = 'block';
                sidePanel.style.display = 'block';
                dashboardGrid.classList.remove('line-chart-mode');
            }
        });

        // Existing JavaScript code for charts and functionality

        // Basic emotion data structure (for pie charts)
        const data = {
            positive: {
                label: 'Positive Emotions',
                color: '#9333ea',
                data: {
                    'Excited': 3,
                    'Curious': 2,
                    'Hopeful': 3,
                    'N/A': 9
                }
            },
            neutral: {
                label: 'Neutral Emotions',
                color: '#90EE90',
                data: {
                    'Happy': 2,
                    'Content': 2,
                    'Calm': 0,
                    'N/A': 13
                }
            },
            concerned: {
                label: 'Concerned Emotions',
                color: '#4169E1',
                data: {
                    'Sad': 2,
                    'Worried': 3,
                    'Pensive': 0,
                    'N/A': 12
                }
            },
            negative: {
                label: 'Negative Emotions',
                color: '#CD5C5C',
                data: {
                    'Angry': 1,
                    'Annoyed': 1,
                    'Indifferent': 2,
                    'N/A': 13
                }
            }
        };

        // Time series data for line chart
        const timeSeriesData = {
            dates: ['10/01/24', '10/08/24', '10/15/24', '10/22/24', '10/29/24'],
            emotions: {
                positive: {
                    excited: [1, 2, 0, 0, 0],     // Emma Wilson (10/01), James Chen & Sophia Lee (10/08)
                    curious: [0, 0, 1, 0, 0],     // Liam Johnson (10/15)
                    hopeful: [0, 2, 1, 0, 0],     // Ava Martinez & Noah Williams (10/08), Isabella Kim (10/15)
                    color: '#9333ea'
                },
                neutral: {
                    happy: [1, 0, 0, 0, 2],       // William Davis (10/01), Charlotte Garcia & Liam Johnson (10/29)
                    content: [0, 1, 0, 0, 1],     // Henry Thompson (10/08), Mia Anderson (10/29)
                    calm: [0, 0, 0, 0, 0],        // No students
                    color: '#90EE90'
                },
                concerned: {
                    sad: [1, 0, 0, 0, 0],         // Lucas Miller (10/01)
                    worried: [0, 0, 3, 0, 0],     // Evelyn Moore, Sebastian Park, Harper Wilson (10/15)
                    pensive: [0, 0, 0, 0, 0],     // No students
                    color: '#4169E1'
                },
                negative: {
                    angry: [1, 0, 0, 0, 0],       // Benjamin Clark (10/01)
                    annoyed: [0, 0, 0, 0, 0],     // Victoria Adams (no date)
                    indifferent: [0, 1, 0, 0, 0], // Alexander Wright (10/08)
                    color: '#CD5C5C'
                }
            }
        };

        // Mock student data
        const studentData = {
            positive: {
                excited: ['Emma Wilson', 'James Chen', 'Sophia Lee'],
                curious: ['Liam Johnson', 'Oliver Brown'],
                hopeful: ['Ava Martinez', 'Noah Williams', 'Isabella Kim']
            },
            neutral: {
                happy: ['William Davis', 'Charlotte Garcia'],
                content: ['Henry Thompson', 'Mia Anderson'],
                calm: []
            },
            concerned: {
                sad: ['Lucas Miller', 'Amelia White'],
                worried: ['Evelyn Moore', 'Sebastian Park', 'Harper Wilson'],
                pensive: []
            },
            negative: {
                angry: ['Benjamin Clark'],
                annoyed: ['Victoria Adams'],
                indifferent: ['Alexander Wright', 'Elizabeth Martinez']
            }
        };

        // Bar chart student data
        const barChartStudentData = {
            '10/01/24': {
                excited: ['Emma Wilson'],
                happy: ['William Davis'],
                angry: ['Benjamin Clark'],
                sad: ['Lucas Miller']
            },
            '10/08/24': {
                excited: ['James Chen', 'Sophia Lee'],
                content: ['Henry Thompson'],
                hopeful: ['Ava Martinez', 'Noah Williams'],
                indifferent: ['Alexander Wright']
            },
            '10/15/24': {
                hopeful: ['Isabella Kim'],
                curious: ['Liam Johnson'],
                worried: ['Evelyn Moore', 'Sebastian Park', 'Harper Wilson']
            },
            '10/29/24': {
                happy: ['Charlotte Garcia', 'Liam Johnson'],
                content: ['Mia Anderson']
            }
        };

        // Comprehensive student list
        const students = [];

        // Build the student list
        Object.entries(barChartStudentData).forEach(([date, emotions]) => {
            Object.entries(emotions).forEach(([emotion, names]) => {
                const category = getEmotionCategory(emotion);
                names.forEach(name => {
                    students.push({
                        name,
                        emotion,
                        category,
                        date
                    });
                });
            });
        });

        // Add students from studentData if they are not already in the list
        Object.entries(studentData).forEach(([category, emotions]) => {
            Object.entries(emotions).forEach(([emotion, names]) => {
                names.forEach(name => {
                    const exists = students.some(student => student.name === name && student.emotion === emotion);
                    if (!exists) {
                        students.push({
                            name,
                            emotion,
                            category,
                            date: ''
                        });
                    }
                });
            });
        });

        // Chart instances
        let mainChart = null;
        let detailChart = null;
        let lineChart = null;
        let barChart = null;
        let currentCategory = null;
        let currentView = 'all';
        let showNegatives = false;
        let hiddenEmotions = new Set();
        let highlightFixed = false;
        let fixedEmotion = null;
        let fixedDate = null;

        // Emotion colors
        const emotionColors = {
            excited: '#9333ea',
            happy: '#90EE90',
            hopeful: '#6b21a8',
            calm: '#34D399',
            angry: '#CD5C5C',
            sad: '#4169E1',
            indifferent: '#B91C1C',
            pensive: '#1D4ED8',
            annoyed: '#EF4444',
            curious: '#7e22ce',
            content: '#6EE7B7',
            worried: '#2563EB'
        };

        // Emotion descriptions
        const emotionDescriptions = {
            excited: 'Showing high energy and enthusiasm',
            happy: 'Content with current situation',
            hopeful: 'Optimistic about progress',
            calm: 'Showing peaceful demeanor',
            angry: 'Displaying frustration or anger',
            sad: 'Showing signs of unhappiness',
            indifferent: 'Lacking engagement',
            pensive: 'Deep in thought, potentially troubled',
            annoyed: 'Showing irritation',
            curious: 'Displaying interest in learning',
            content: 'Satisfied with progress',
            worried: 'Expressing anxiety or concern'
        };

        // Initialize main pie chart
        function initializeMainChart() {
            const ctx = document.getElementById('mainChart').getContext('2d');
            mainChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.values(data).map(category => category.label),
                    datasets: [{
                        data: Object.values(data).map(category =>
                            Object.values(category.data).reduce((a, b) => a + b, 0)
                        ),
                        backgroundColor: Object.values(data).map(category => category.color)
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { font: { size: 11 } }
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const value = context.raw;
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${context.label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    },
                    onClick: function (event, elements) {
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            const category = Object.keys(data)[index];
                            showDetailChart(category);
                            updateStudentList(category);
                        }
                    }
                }
            });
        }

        // Show detail pie chart
        function showDetailChart(category) {
            const mainChartArea = document.querySelector('.main-chart-area');
            const detailChartArea = document.querySelector('.detail-chart-area');
            const backButton = document.querySelector('.back-button');

            mainChartArea.style.display = 'none';
            detailChartArea.style.display = 'block';
            backButton.style.display = 'block';
            currentCategory = category;

            const categoryData = data[category];
            if (detailChart) {
                detailChart.destroy();
            }

            detailChart = new Chart(document.getElementById('detailChart'), {
                type: 'pie',
                data: {
                    labels: Object.keys(categoryData.data),
                    datasets: [{
                        data: Object.values(categoryData.data),
                        backgroundColor: [
                            categoryData.color,
                            shadeColor(categoryData.color, 20),
                            shadeColor(categoryData.color, 40),
                            '#f0f0f0'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { font: { size: 11 } }
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const value = context.raw;
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${context.label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    },
                    onClick: function (event, elements) {
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            const emotion = detailChart.data.labels[index];
                            updateStudentList(currentCategory, emotion);
                        }
                    }
                }
            });
        }

        // Create line chart
        function createLineChart(view = 'all') {
            const ctx = document.getElementById('lineChart').getContext('2d');
            if (lineChart) {
                lineChart.destroy();
            }

            let datasets = [];

            if (view === 'all') {
                // Show all individual emotions
                Object.entries(timeSeriesData.emotions).forEach(([category, categoryData]) => {
                    Object.entries(categoryData).forEach(([emotion, values]) => {
                        if (emotion !== 'color') {
                            datasets.push({
                                label: capitalizeFirstLetter(emotion),
                                data: values,
                                borderColor: emotionColors[emotion],
                                backgroundColor: emotionColors[emotion],
                                tension: 0.4,
                                borderWidth: 2,
                                pointRadius: 4,
                                pointHoverRadius: 6
                            });
                        }
                    });
                });
            } else {
                // Show category totals
                Object.entries(timeSeriesData.emotions).forEach(([category, categoryData]) => {
                    const categoryTotals = timeSeriesData.dates.map((_, index) => {
                        return Object.entries(categoryData).reduce((sum, [emotion, values]) => {
                            return emotion !== 'color' ? sum + (Array.isArray(values) ? values[index] : 0) : sum;
                        }, 0);
                    });

                    datasets.push({
                        label: capitalizeFirstLetter(category),
                        data: categoryTotals,
                        borderColor: categoryData.color,
                        backgroundColor: categoryData.color,
                        tension: 0.4,
                        borderWidth: 3,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    });
                });
            }

            lineChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: timeSeriesData.dates,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            enabled: false,
                            external: function (context) {
                                const tooltip = document.getElementById('dataPointInfo');

                                if (context.tooltip.opacity === 0) {
                                    tooltip.style.display = 'none';
                                    return;
                                }

                                const data = context.tooltip.dataPoints;
                                let html = `<div><strong>${context.tooltip.title}</strong></div>`;
                                data.forEach(point => {
                                    html += `<div style="color: ${point.dataset.borderColor}">${point.dataset.label}: ${point.raw}</div>`;
                                });

                                tooltip.innerHTML = html;
                                tooltip.style.display = 'block';

                                // Position the tooltip with offset to prevent it from going off-screen
                                const chartArea = document.querySelector('.chart-wrapper');
                                const chartRect = chartArea.getBoundingClientRect();
                                const tooltipRect = tooltip.getBoundingClientRect();

                                let left = context.tooltip.caretX;
                                let top = context.tooltip.caretY;

                                // Adjust horizontal position if tooltip would go off right edge
                                if (left + tooltipRect.width > chartRect.right) {
                                    left = chartRect.right - tooltipRect.width - 10;
                                }

                                // Adjust vertical position if tooltip would go off bottom
                                if (top + tooltipRect.height > chartRect.bottom) {
                                    top = chartRect.bottom - tooltipRect.height - 10;
                                }

                                tooltip.style.left = left + 'px';
                                tooltip.style.top = top + 'px';
                            }
                        },
                        title: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1,
                                font: {
                                    size: 11
                                }
                            },
                            grid: {
                                color: '#e0e0e0'
                            }
                        },
                        x: {
                            grid: {
                                display: true,
                                color: '#e0e0e0'
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45,
                                autoSkip: true,
                                maxTicksLimit: 10,
                                font: {
                                    size: 11
                                }
                            }
                        },
                        layout: {
                            padding: {
                                left: 10,
                                right: 20,
                                top: 20,
                                bottom: 10
                            }
                        }
                    }
                }
            });

            updateDataTable(datasets);
            updateLegend(datasets);
        }

        // Helper functions
        function updateDataTable(datasets) {
            const table = document.getElementById('dataTable');
            let html = '<tr><th>Date</th>';

            datasets.forEach(dataset => {
                html += `<th style="color: ${dataset.borderColor}">${dataset.label}</th>`;
            });
            html += '</tr>';

            timeSeriesData.dates.forEach((date, index) => {
                html += `<tr><td>${date}</td>`;
                datasets.forEach(dataset => {
                    html += `<td>${dataset.data[index]}</td>`;
                });
                html += '</tr>';
            });

            table.innerHTML = html;
        }

        function updateLegend(datasets) {
            const legend = document.getElementById('chartLegend');
            legend.innerHTML = datasets.map(dataset => `
                <div class="legend-item">
                    <div class="legend-color" style="background: ${dataset.borderColor}"></div>
                    ${dataset.label}
                </div>
            `).join('');

            // Add click handlers to legend items
            legend.querySelectorAll('.legend-item').forEach((item, index) => {
                item.addEventListener('click', () => {
                    const datasetLabel = datasets[index].label.toLowerCase();
                    let category = null;
                    let emotion = null;

                    // Find the category and emotion
                    Object.entries(timeSeriesData.emotions).forEach(([cat, catData]) => {
                        Object.keys(catData).forEach(emo => {
                            if (emo === datasetLabel) {
                                category = cat;
                                emotion = emo;
                            }
                        });
                    });

                    if (category && emotion) {
                        updateStudentList(category, capitalizeFirstLetter(emotion));
                    }
                });
            });
        }

        function updateStudentList(category = null, emotion = null, date = null) {
            const tableBody = document.getElementById('studentTableBody');
            const studentCount = document.getElementById('studentCount');

            let filteredStudents = students;

            if (category) {
                filteredStudents = filteredStudents.filter(student => student.category === category);
            }

            if (emotion) {
                filteredStudents = filteredStudents.filter(student => student.emotion.toLowerCase() === emotion.toLowerCase());
            }

            if (date) {
                filteredStudents = filteredStudents.filter(student => student.date === date);
            }

            // Sort students: high-risk negative emotions first
            const categoryOrder = { 'negative': 1, 'concerned': 2, 'neutral': 3, 'positive': 4 };
            filteredStudents.sort((a, b) => {
                const categoryComparison = categoryOrder[a.category] - categoryOrder[b.category];
                if (categoryComparison !== 0) return categoryComparison;
                return a.name.localeCompare(b.name);
            });

            tableBody.innerHTML = filteredStudents.map(student => `
                <tr class="student-row" data-name="${student.name}" data-emotion="${student.emotion}" data-date="${student.date}">
                    <td>${student.name}</td>
                    <td>
                        <span class="emotion-tag ${student.category}">
                            ${capitalizeFirstLetter(student.emotion)}
                        </span>
                    </td>
                </tr>
            `).join('');

            studentCount.textContent = `${filteredStudents.length} student${filteredStudents.length !== 1 ? 's' : ''}`;

            updateFilterInfo();
        }

        function capitalizeFirstLetter(string) {
            return string.charAt(0).toUpperCase() + string.slice(1);
        }

        function shadeColor(color, percent) {
            let R = parseInt(color.substring(1, 3), 16);
            let G = parseInt(color.substring(3, 5), 16);
            let B = parseInt(color.substring(5, 7), 16);

            R = parseInt(R * (100 + percent) / 100);
            G = parseInt(G * (100 + percent) / 100);
            B = parseInt(B * (100 + percent) / 100);

            R = (R < 255) ? R : 255;
            G = (G < 255) ? G : 255;
            B = (B < 255) ? B : 255;

            const RR = ((R.toString(16).length == 1) ? "0" + R.toString(16) : R.toString(16));
            const GG = ((G.toString(16).length == 1) ? "0" + G.toString(16) : G.toString(16));
            const BB = ((B.toString(16).length == 1) ? "0" + B.toString(16) : B.toString(16));

            return "#" + RR + GG + BB;
        }

        function getEmotionCategory(emotion) {
            for (let [category, emotions] of Object.entries(studentData)) {
                if (emotions[emotion]) {
                    return category;
                }
            }
            return 'unknown';
        }

        // Update filter info display
        function updateFilterInfo() {
            const filterInfo = document.getElementById('filterInfo');
            if (highlightFixed && fixedEmotion && fixedDate) {
                filterInfo.textContent = `Showing students feeling ${capitalizeFirstLetter(fixedEmotion)} on ${fixedDate}`;
            } else {
                filterInfo.textContent = 'Showing all students';
            }
        }

        // Bar Chart Implementation
        const barChartData = [
            {
                date: '10/01/24',
                excited: 1.25,
                happy: 0.25,
                angry: -1.25,
                sad: -0.83
            },
            {
                date: '10/08/24',
                hopeful: 1.0,
                content: 0.75,
                indifferent: -0.5,
                pensive: -0.4
            },
            {
                date: '10/15/24',
                curious: 0.5,
                worried: -1.5
            },
            {
                date: '10/29/24',
                happy: 0.5,
                content: 0.25
            }
        ];

        function initializeBarChart() {
            const ctx = document.getElementById('barChart').getContext('2d');

            if (barChart) {
                barChart.destroy();
            }

            const processedData = processBarChartData(barChartData);

            barChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: processedData.labels,
                    datasets: processedData.datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: '#e0e0e0'
                            },
                            ticks: {
                                font: {
                                    size: 11
                                }
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45,
                                font: {
                                    size: 11
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            enabled: true,
                            mode: 'nearest',
                            intersect: true,
                            callbacks: {
                                title: function (tooltipItems) {
                                    return 'Date: ' + tooltipItems[0].label;
                                },
                                label: function (tooltipItem) {
                                    const emotion = tooltipItem.dataset.label.toLowerCase();
                                    const date = tooltipItem.label;
                                    const studentsForEmotionDate = getStudentsForEmotionAndDate(emotion, date);
                                    return [
                                        `${tooltipItem.dataset.label}: ${tooltipItem.formattedValue}`,
                                        `Students: ${studentsForEmotionDate.length}`,
                                        ...studentsForEmotionDate.map(student => `- ${student.name}`)
                                    ];
                                }
                            }
                        }
                    },
                    onHover: function (event, chartElements) {
                        if (chartElements.length > 0 && !highlightFixed) {
                            const element = chartElements[0];
                            const datasetIndex = element.datasetIndex;
                            const index = element.index;
                            const dataset = this.data.datasets[datasetIndex];
                            const label = this.data.labels[index]; // date
                            const emotion = dataset.label.toLowerCase();
                            updateStudentList(null, emotion, label);
                        } else if (!highlightFixed) {
                            updateStudentList();
                        }
                    },
                    onClick: function (event, elements) {
                        if (!event || !elements) return;
                        event.native.stopPropagation();

                        if (elements.length > 0) {
                            const element = elements[0];
                            const datasetIndex = element.datasetIndex;
                            const index = element.index;
                            const dataset = this.data.datasets[datasetIndex];
                            const label = this.data.labels[index];
                            const emotion = dataset.label.toLowerCase();

                            if (highlightFixed && fixedEmotion === emotion && fixedDate === label) {
                                // If clicking the same bar, clear the selection
                                highlightFixed = false;
                                fixedEmotion = null;
                                fixedDate = null;
                                updateStudentList();
                            } else {
                                // Set new selection
                                highlightFixed = true;
                                fixedEmotion = emotion;
                                fixedDate = label;
                                updateStudentList(null, emotion, label);
                            }
                            updateFilterInfo();
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        intersect: true
                    }
                }
            });

            updateBarChartLegend(processedData.datasets);
            updateStudentList(); // Update student list based on initial bar chart
        }

        function processBarChartData(data) {
            const labels = data.map(item => item.date);
            const datasets = [];

            // Get all unique emotions
            const emotions = new Set();
            data.forEach(item => {
                Object.keys(item).forEach(key => {
                    if (key !== 'date') emotions.add(key);
                });
            });

            // Create datasets
            emotions.forEach(emotion => {
                const dataset = {
                    label: capitalizeFirstLetter(emotion),
                    data: data.map(item => {
                        const value = item[emotion] || 0;
                        return showNegatives ? value : Math.abs(value);
                    }),
                    backgroundColor: emotionColors[emotion],
                    borderColor: emotionColors[emotion],
                    borderWidth: 1,
                    hidden: hiddenEmotions.has(emotion)
                };
                datasets.push(dataset);
            });

            return { labels, datasets };
        }

        function updateBarChartLegend(datasets) {
            const legendContainer = document.getElementById('barChartLegend');
            legendContainer.innerHTML = '';

            datasets.forEach((dataset, index) => {
                const legendItem = document.createElement('div');
                legendItem.classList.add('legend-item');
                if (dataset.hidden) {
                    legendItem.classList.add('hidden');
                }
                legendItem.dataset.emotion = dataset.label.toLowerCase();

                legendItem.innerHTML = `
                    <div class="legend-color" style="background: ${dataset.backgroundColor}"></div>
                    ${dataset.label}
                `;

                legendItem.addEventListener('click', () => {
                    const emotion = legendItem.dataset.emotion;
                    dataset.hidden = !dataset.hidden;
                    if (dataset.hidden) {
                        hiddenEmotions.add(emotion);
                        legendItem.classList.add('hidden');
                    } else {
                        hiddenEmotions.delete(emotion);
                        legendItem.classList.remove('hidden');
                    }
                    barChart.update();
                    updateStudentList();
                });

                legendContainer.appendChild(legendItem);
            });
        }

        // Bar chart toggle handlers
        document.querySelectorAll('.chart-toggle-button').forEach(button => {
            button.addEventListener('click', function (e) {
                const view = e.target.dataset.view;
                document.querySelectorAll('.chart-toggle-button').forEach(btn =>
                    btn.classList.remove('active')
                );
                e.target.classList.add('active');
                showNegatives = view === 'negative';
                initializeBarChart();
            });
        });

        document.addEventListener('click', function (event) {
            if (!event.target.closest('#barChart') &&
                !event.target.closest('.student-table')) {
                if (highlightFixed) {
                    highlightFixed = false;
                    fixedEmotion = null;
                    fixedDate = null;
                    updateStudentList();
                    updateFilterInfo();
                }
            }
        });

        // Add event listeners for line chart toggle buttons
        document.querySelectorAll('.toggle-button-chart').forEach(button => {
            button.addEventListener('click', function (e) {
                document.querySelectorAll('.toggle-button-chart').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                currentView = e.target.dataset.view;
                createLineChart(currentView);
            });
        });

        // Back button handler
        document.querySelector('.back-button').addEventListener('click', () => {
            document.querySelector('.main-chart-area').style.display = 'block';
            document.querySelector('.detail-chart-area').style.display = 'none';
            document.querySelector('.back-button').style.display = 'none';
            currentCategory = null;
            updateStudentList(); // Reset to show all students
        });

        // Helper function to get students for a specific emotion and date
        function getStudentsForEmotionAndDate(emotion, date) {
            return students.filter(student =>
                student.emotion.toLowerCase() === emotion.toLowerCase() && student.date === date
            );
        }

        // Initialize the dashboard
        initializeMainChart();
        updateStudentList();

        // Set initial chart visibility based on selected chart type
        (function () {
            const chartType = chartTypeSelect.value; // This will now be 'pie' by default
            const mainChartArea = document.querySelector('.main-chart-area');
            const detailChartArea = document.querySelector('.detail-chart-area');
            const lineChartArea = document.querySelector('.line-chart-area');
            const barChartArea = document.querySelector('.bar-chart-area');
            const sidePanel = document.querySelector('.side-panel');
            const dashboardGrid = document.querySelector('.dashboard-grid');

            // Hide all chart areas first
            mainChartArea.style.display = 'none';
            detailChartArea.style.display = 'none';
            lineChartArea.style.display = 'none';
            barChartArea.style.display = 'none';

            if (chartType === 'line') {
                lineChartArea.style.display = 'block';
                sidePanel.style.display = 'none';
                dashboardGrid.classList.add('line-chart-mode');
                createLineChart(currentView);
            } else if (chartType === 'bar') {
                barChartArea.style.display = 'block';
                sidePanel.style.display = 'block';
                dashboardGrid.classList.remove('line-chart-mode');
                initializeBarChart();
            } else {
                mainChartArea.style.display = 'block';
                sidePanel.style.display = 'block';
                dashboardGrid.classList.remove('line-chart-mode');
            }
        })();

    </script>
</body>

</html>
